<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="page-title">QRelax - Caricamento...</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --ink:#2D3748; --muted:#6B7280; --soft:#F0F9FF; --line:#E5E7EB; --accent:#7DD3FC;
      --primary:#2D3748; --secondary:#7DD3FC; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    [data-theme="dark"] {
      --bg:#1a202c; --ink:#f7fafc; --muted:#a0aec0; --soft:#2d3748; --line:#4a5568; 
      --primary:#f7fafc; --secondary:#63b3ed; --shadow:0 10px 30px rgba(0,0,0,.3);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .q-container{max-width:1120px;margin:0 auto;padding:20px}
    .q-grid{display:grid;gap:14px}
    @media (min-width:768px){ .q-grid.cols-2{grid-template-columns:repeat(2,1fr)} .q-grid.cols-3{grid-template-columns:repeat(3,1fr)} }
    .hero{padding:28px 0}
    .hero-grid{display:grid;gap:16px}
    @media(min-width:768px){ .hero-grid{grid-template-columns:1fr 420px;align-items:center} }
    .hero-cover{border-radius:12px;overflow:hidden;background:#eee;height:260px}
    .q-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;border:1px solid rgba(0,0,0,.04)}
    .q-title{font-weight:700;margin:0 0 6px}
    .q-text{color:var(--muted);margin:0}
    .q-small{font-size:.92rem;color:var(--muted)}
    .q-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .q-action{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:120px;text-align:center;border-radius:12px}
    .q-link{display:block;text-decoration:none;color:var(--ink)}
    .q-ico{width:20px;height:20px;stroke:currentColor;fill:none;display:inline-block}
    .q-ico-sm{width:16px;height:16px}
    .q-img{position:relative;aspect-ratio:16/9;background:#ddd;overflow:hidden;border-radius:10px}
    .q-img img{width:100%;height:100%;object-fit:cover}
    .q-chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
    .q-chip{font-size:.78rem;background:var(--soft);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .q-cta{display:flex;gap:8px;margin-top:12px}
    .q-btn{display:inline-flex;align-items:center;gap:8px;font-size:.9rem;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);text-decoration:none}
    .q-btn-primary{background:var(--secondary);color:var(--primary);border:none;font-weight:600}
    .q-btn-secondary{background:var(--primary);color:#fff;border:none}
    .lang-switcher{position:absolute;top:20px;right:20px;display:flex;gap:4px;align-items:center}
    .theme-toggle{padding:6px 10px;border:1px solid var(--line);background:var(--bg);color:var(--muted);border-radius:6px;font-size:.8rem;transition:all 0.2s;cursor:pointer}
    .theme-toggle:hover{background:var(--secondary);color:var(--primary);border-color:var(--secondary)}
    .lang-btn{padding:6px 10px;border:1px solid var(--line);background:#fff;color:var(--muted);text-decoration:none;border-radius:6px;font-size:.8rem;transition:all 0.2s}
    .lang-btn.active,.lang-btn:hover{background:var(--secondary);color:var(--primary);border-color:var(--secondary)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .brand-logo{width:60px;height:auto}
    .q-bottom{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-around;background:#fff;border-top:1px solid var(--line);padding:8px 10px;z-index:999}
    .q-bottom a{display:flex;flex-direction:column;align-items:center;font-size:.72rem;color:var(--ink);text-decoration:none}
    .q-bottom svg{width:18px;height:18px;margin-bottom:4px}
    .loading{display:flex;align-items:center;justify-content:center;height:200px;color:var(--muted)}
    .error{background:#fee;border:1px solid #fcc;color:#c33;padding:20px;border-radius:8px;margin:20px 0}
    @media(max-width:480px){
      .q-container{padding:12px}
      .hero-cover{height:180px}
      .q-action{min-height:100px}
    }
    .muted{color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .hidden{display:none}
    .weather-widget{background:var(--soft);border:1px solid var(--line);padding:16px;border-radius:12px;margin-bottom:16px}
    .weather-info{display:flex;align-items:center;gap:12px}
    .weather-temp{font-size:2rem;font-weight:700;color:var(--primary)}
    .weather-desc{color:var(--muted);font-size:.9rem}
    .filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .filter-btn{padding:8px 16px;border:1px solid var(--line);background:var(--bg);color:var(--muted);border-radius:20px;font-size:.85rem;cursor:pointer;transition:all 0.2s}
    .filter-btn:hover,.filter-btn.active{background:var(--secondary);color:var(--primary);border-color:var(--secondary)}
    .skip-link{position:absolute;top:-40px;left:0;background:var(--primary);color:#fff;padding:8px;z-index:100;transition:top 0.3s}
    .skip-link:focus{top:0}
    [aria-live]{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>

  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="q-house" viewBox="0 0 24 24"><path d="M3 10L12 3l9 7v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10Z" stroke-width="2"/></symbol>
    <symbol id="q-restaurant" viewBox="0 0 24 24"><path d="M6 3v18M10 3v8a2 2 0 1 0 4 0V3M18 3v18" stroke-width="2"/></symbol>
    <symbol id="q-activity" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v5l4 2" stroke-width="2"/></symbol>
    <symbol id="q-wifi" viewBox="0 0 24 24"><path d="M2 8a16 16 0 0 1 20 0M5 12a11 11 0 0 1 14 0M9 16a6 6 0 0 1 6 0" stroke-width="2"/></symbol>
    <symbol id="q-calendar" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2"/><path d="M8 2v4M16 2v4M3 10h18" stroke-width="2"/></symbol>
    <symbol id="q-doc" viewBox="0 0 24 24"><path d="M6 4h9l3 3v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke-width="2"/></symbol>
    <symbol id="q-plus" viewBox="0 0 24 24"><path d="M12 2v20M2 12h20" stroke-width="2"/></symbol>
    <symbol id="q-phone" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.09 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.9.33 1.77.62 2.6a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6" stroke-width="2"/></symbol>
    <symbol id="q-pin" viewBox="0 0 24 24"><path d="M12 22s7-6.5 7-12a7 7 0 0 0-14 0c0 5.5 7 12 7 12Z" stroke-width="2"/><circle cx="12" cy="10" r="3" stroke-width="2"/></symbol>
    <symbol id="q-globe" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke-width="2"/></symbol>
    <symbol id="q-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" stroke-width="2"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-width="2"/></symbol>
    <symbol id="q-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"/></symbol>
    <symbol id="q-cloud" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/></symbol>
  </svg>

  <a href="#main-content" class="skip-link">Salta al contenuto principale</a>
  <div aria-live="polite" aria-atomic="true" id="announcer"></div>

  <div id="loading" class="loading">Caricamento appartamento...</div>
  <div id="error" class="error hidden">Errore nel caricamento dei dati. Controlla che il file JSON esista.</div>

  <div id="app" class="hidden">
    <div class="q-container">
      <div class="lang-switcher">
        <button class="theme-toggle" id="theme-toggle" aria-label="Cambia tema">
          <svg class="q-ico" id="theme-icon"><use href="#q-sun"/></svg>
        </button>
        <a href="#" class="lang-btn active" data-lang="it">IT</a>
        <a href="#" class="lang-btn" data-lang="en">EN</a>
        <a href="#" class="lang-btn" data-lang="de">DE</a>
      </div>

      <header class="hero" id="main-content">
        <!-- Weather Widget -->
        <div id="weather-widget" class="weather-widget hidden">
          <div class="weather-info">
            <svg class="q-ico" style="width:48px;height:48px"><use href="#q-cloud"/></svg>
            <div>
              <div class="weather-temp" id="weather-temp">--¬∞</div>
              <div class="weather-desc" id="weather-desc">Caricamento meteo...</div>
              <div class="q-small" id="weather-location"></div>
            </div>
          </div>
        </div>

        <div class="hero-grid">
          <div>
            <div class="brand">
              <svg class="brand-logo" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                <text x="0" y="45" font-family="Inter, sans-serif" font-weight="700" font-size="48" fill="#2D3748">QR</text>
                <text x="80" y="45" font-family="Inter, sans-serif" font-weight="400" font-size="48" fill="#7DD3FC">ELAX</text>
              </svg>
            </div>
            <h1 class="q-title" id="apt-nome">Caricamento...</h1>
            <p class="q-text" id="apt-indirizzo">Caricamento indirizzo...</p>

            <div class="q-grid cols-3" style="margin-top:14px">
              <a class="q-card q-action q-link" href="#casa"><svg class="q-ico"><use href="#q-house"/></svg><div class="q-title" data-i18n="house">La casa</div><p class="q-text" data-i18n="house-desc">TV, clima, riscaldamento</p></a>
              <a class="q-card q-action q-link" href="#mangiare"><svg class="q-ico"><use href="#q-restaurant"/></svg><div class="q-title" data-i18n="eat">Mangiare</div><p class="q-text" data-i18n="eat-desc">Ristoranti locali</p></a>
              <a class="q-card q-action q-link" href="#attivita"><svg class="q-ico"><use href="#q-activity"/></svg><div class="q-title" data-i18n="activities">Attivit√†</div><p class="q-text" data-i18n="activities-desc">Esperienze e svago</p></a>
            </div>
          </div>

          <div class="hero-cover center"><img id="apt-cover" src="" alt="Appartamento" style="width:100%;height:100%;object-fit:cover"></div>
        </div>
      </header>

      <section class="q-grid cols-2" style="margin-top:18px">
        <div class="q-card">
          <div class="q-row"><svg class="q-ico"><use href="#q-wifi"/></svg><div class="q-title" data-i18n="wifi">Wi-Fi</div></div>
          <p class="q-small"><strong>SSID:</strong> <span id="wifi-ssid">‚Äî</span></p>
          <p class="q-small"><strong data-i18n="password">Password:</strong> <span id="wifi-pass">‚Äî</span></p>
          <a href="#" class="q-btn" id="copyPass" data-i18n="copy-password">Copia password</a><span class="muted" id="copiedMsg" style="display:none;margin-left:8px" data-i18n="copied">Copiata ‚úÖ</span>
        </div>

        <div class="q-card">
          <div class="q-row"><svg class="q-ico"><use href="#q-calendar"/></svg><div class="q-title" data-i18n="checkin-checkout">Check-in / Check-out</div></div>
          <p class="q-small"><span data-i18n="checkin">Check-in</span>: <span id="checkin">‚Äî</span> ‚Ä¢ <span data-i18n="checkout">Check-out</span>: <span id="checkout">‚Äî</span></p>
          <div style="margin-top:10px"><strong data-i18n="host">Host:</strong> <span id="host-info">‚Äî</span></div>
          <p class="q-small" id="checkin-note" style="margin-top:6px;font-style:italic"></p>
        </div>

        <div class="q-card">
          <div class="q-row"><svg class="q-ico"><use href="#q-doc"/></svg><div class="q-title" data-i18n="house-rules">Regole della casa</div></div>
          <div class="q-small" id="regole">‚Äî</div>
        </div>

        <div class="q-card">
          <div class="q-row"><svg class="q-ico"><use href="#q-plus"/></svg><div class="q-title" data-i18n="emergencies">Emergenze</div></div>
          <div class="q-small" id="emergenze">‚Äî</div>
        </div>
      </section>

      <section id="casa" style="margin-top:18px">
        <div class="q-title" data-i18n="house-operations">Funzionamento della casa</div>
        <div class="q-card" style="margin-top:8px">
          <div id="funzionamento" class="q-small">‚Äî</div>
        </div>
      </section>

      <section id="mangiare" style="margin-top:18px">
        <div class="q-title" data-i18n="where-eat">Dove mangiare</div>
        
        <!-- Filtri Ristoranti -->
        <div class="filter-bar" role="group" aria-label="Filtri ristoranti">
          <button class="filter-btn active" data-filter="all" data-i18n="filter-all">Tutti</button>
          <button class="filter-btn" data-filter="‚Ç¨" aria-label="Fascia economica">‚Ç¨</button>
          <button class="filter-btn" data-filter="‚Ç¨‚Ç¨" aria-label="Fascia media">‚Ç¨‚Ç¨</button>
          <button class="filter-btn" data-filter="‚Ç¨‚Ç¨‚Ç¨" aria-label="Fascia alta">‚Ç¨‚Ç¨‚Ç¨</button>
          <button class="filter-btn" data-filter="vicino" data-i18n="filter-nearby">Vicino</button>
        </div>
        
        <div id="luoghi-wrap" class="q-grid cols-3" style="margin-top:10px"></div>
      </section>

      <section id="attivita" style="margin-top:18px">
        <div class="q-title" data-i18n="recommended-activities">Attivit√† consigliate</div>
        <div id="attivita-wrap" class="q-grid cols-3" style="margin-top:10px"></div>
      </section>

      <section id="galleria" style="margin-top:18px">
        <div class="q-title" data-i18n="gallery">Galleria</div>
        <div id="gallery-wrap" class="q-grid cols-2" style="margin-top:10px"></div>
      </section>

      <section id="contatti" style="margin-top:18px;margin-bottom:120px">
        <div class="q-grid cols-2">
          <div class="q-card">
            <div class="q-title" data-i18n="contacts">Contatti</div>
            <div class="q-small" id="contact-block">‚Äî</div>
            <div style="margin-top:16px">
              <a href="#" class="q-btn q-btn-primary" id="feedback-link" style="text-decoration:none;display:inline-flex">
                ‚≠ê Lascia un feedback
              </a>
            </div>
          </div>
          <div class="q-card">
            <div class="q-title" data-i18n="map">Mappa</div>
            <div class="q-img" style="padding:0;margin-top:8px">
              <iframe id="mappa" src="" width="100%" height="260" style="border:0" allowfullscreen="" loading="lazy"></iframe>
            </div>
          </div>
        </div>
      </section>
    </div>

    <nav class="q-bottom">
      <a href="#home"><svg><use href="#q-house"/></svg><span data-i18n="home">Home</span></a>
      <a href="#casa"><svg><use href="#q-activity"/></svg><span data-i18n="casa-nav">Casa</span></a>
      <a href="#mangiare"><svg><use href="#q-restaurant"/></svg><span data-i18n="eat-nav">Mangiare</span></a>
      <a href="#contatti"><svg><use href="#q-doc"/></svg><span data-i18n="contacts">Contatti</span></a>
    </nav>
  </div>

  <script>
  // =========================
  //      TRADUZIONI
  // =========================
  const TRANSLATIONS = {
    it: {
      'house': 'La casa', 'house-desc': 'TV, clima, riscaldamento', 'eat': 'Mangiare', 'eat-desc': 'Ristoranti locali',
      'activities': 'Attivit√†', 'activities-desc': 'Esperienze e svago', 'wifi': 'Wi-Fi', 'password': 'Password',
      'copy-password': 'Copia password', 'copied': 'Copiata ‚úÖ', 'checkin-checkout': 'Check-in / Check-out',
      'checkin': 'Check-in', 'checkout': 'Check-out', 'host': 'Host', 'house-rules': 'Regole della casa',
      'emergencies': 'Emergenze', 'house-operations': 'Funzionamento della casa', 'where-eat': 'Dove mangiare',
      'recommended-activities': 'Attivit√† consigliate', 'gallery': 'Galleria', 'contacts': 'Contatti',
      'map': 'Mappa', 'maps': 'Maps', 'call': 'Chiama', 'home': 'Home', 'casa-nav': 'Casa', 'eat-nav': 'Mangiare',
      'filter-all': 'Tutti', 'filter-nearby': 'Vicino'
    },
    en: {
      'house': 'The house', 'house-desc': 'TV, air conditioning, heating', 'eat': 'Dining', 'eat-desc': 'Local restaurants',
      'activities': 'Activities', 'activities-desc': 'Experiences and entertainment', 'wifi': 'Wi-Fi', 'password': 'Password',
      'copy-password': 'Copy password', 'copied': 'Copied ‚úÖ', 'checkin-checkout': 'Check-in / Check-out',
      'checkin': 'Check-in', 'checkout': 'Check-out', 'host': 'Host', 'house-rules': 'House rules',
      'emergencies': 'Emergencies', 'house-operations': 'How the house works', 'where-eat': 'Where to eat',
      'recommended-activities': 'Recommended activities', 'gallery': 'Gallery', 'contacts': 'Contacts',
      'map': 'Map', 'maps': 'Maps', 'call': 'Call', 'home': 'Home', 'casa-nav': 'House', 'eat-nav': 'Dining',
      'filter-all': 'All', 'filter-nearby': 'Nearby'
    },
    de: {
      'house': 'Das Haus', 'house-desc': 'TV, Klimaanlage, Heizung', 'eat': 'Essen', 'eat-desc': 'Lokale Restaurants',
      'activities': 'Aktivit√§ten', 'activities-desc': 'Erlebnisse und Unterhaltung', 'wifi': 'Wi-Fi', 'password': 'Passwort',
      'copy-password': 'Passwort kopieren', 'copied': 'Kopiert ‚úÖ', 'checkin-checkout': 'Check-in / Check-out',
      'checkin': 'Check-in', 'checkout': 'Check-out', 'host': 'Gastgeber', 'house-rules': 'Hausregeln',
      'emergencies': 'Notf√§lle', 'house-operations': 'Wie das Haus funktioniert', 'where-eat': 'Wo man essen kann',
      'recommended-activities': 'Empfohlene Aktivit√§ten', 'gallery': 'Galerie', 'contacts': 'Kontakte',
      'map': 'Karte', 'maps': 'Maps', 'call': 'Anrufen', 'home': 'Home', 'casa-nav': 'Haus', 'eat-nav': 'Essen',
      'filter-all': 'Alle', 'filter-nearby': 'In der N√§he'
    }
  };

  let currentLang = 'it';
  let apartmentData = null;
  let allRestaurants = [];

  // =========================
  //        THEME
  // =========================
  function initTheme() {
    const saved = localStorage.getItem('qrelax-theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = saved || (prefersDark ? 'dark' : 'light');
    setTheme(theme);
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('qrelax-theme', theme);
    const icon = document.getElementById('theme-icon');
    if (icon) {
      icon.innerHTML = `<use href="#q-${theme === 'dark' ? 'sun' : 'moon'}"/>`;
    }
  }

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
    announce(`Tema cambiato in ${next === 'dark' ? 'scuro' : 'chiaro'}`);
  }

  // =========================
  //         METEO
  // =========================
  async function loadWeather(lat, lon, cityName) {
    try {
      const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      const data = await response.json();
      const widget = document.getElementById('weather-widget');
      const temp = Math.round(data.current_weather.temperature);
      const weatherCode = data.current_weather.weathercode;

      document.getElementById('weather-temp').textContent = `${temp}¬∞C`;
      document.getElementById('weather-desc').textContent = getWeatherDescription(weatherCode);
      document.getElementById('weather-location').textContent = cityName;

      widget.classList.remove('hidden');
    } catch (error) {
      console.error('Errore caricamento meteo:', error);
    }
  }

  function getWeatherDescription(code) {
    const descriptions = {
      0: '‚òÄÔ∏è Sereno', 1: 'üå§Ô∏è Parzialmente nuvoloso', 2: '‚õÖ Nuvoloso', 3: '‚òÅÔ∏è Coperto',
      45: 'üå´Ô∏è Nebbia', 48: 'üå´Ô∏è Nebbia', 51: 'üå¶Ô∏è Pioggia leggera', 61: 'üåßÔ∏è Pioggia',
      80: 'üå¶Ô∏è Rovesci', 95: '‚õàÔ∏è Temporale'
    };
    return descriptions[code] || 'üå°Ô∏è Meteo';
  }

  // =========================
  //        FILTRI
  // =========================
  function filterRestaurants(filter) {
    const cards = document.querySelectorAll('#luoghi-wrap article');
    cards.forEach(card => {
      const price = card.dataset.price;
      const distance = parseInt(card.dataset.distance || '999', 10);
      let show = false;
      if (filter === 'all') show = true;
      else if (filter === 'vicino') show = distance <= 10;
      else show = price === filter;
      card.style.display = show ? 'block' : 'none';
    });
    announce(`Filtro applicato: ${filter}`);
  }

  // =========================
  //     ACCESSIBILIT√Ä & UTILS
  // =========================
  function announce(message) {
    const announcer = document.getElementById('announcer');
    if (announcer) {
      announcer.textContent = message;
      setTimeout(() => announcer.textContent = '', 1000);
    }
  }

  function getApartmentSlug() {
    const params = new URLSearchParams(window.location.search);
    return params.get('apt') || 'papaya';
    // Esempio: index.html?apt=template -> carica template.json
  }

  async function loadApartmentData(slug) {
    try {
      const response = await fetch(`${slug}.json`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      apartmentData = data;
      return data;
    } catch (error) {
      console.error('Errore caricamento dati:', error);
      showError();
      return null;
    }
  }

  function showError() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('error').classList.remove('hidden');
  }

  function showApp() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
  }

  // =========================
  //        RENDERING
  // =========================
  function renderApartment(data) {
    document.getElementById('page-title').textContent = data.nome || 'QRelax';
    document.getElementById('apt-nome').textContent = data.nome || '';
    document.getElementById('apt-indirizzo').textContent = data.indirizzo || '';
    document.getElementById('apt-cover').src = data.foto_copertina || '';
    document.getElementById('wifi-ssid').textContent = data.wifi_ssid || '‚Äî';
    document.getElementById('wifi-pass').textContent = data.wifi_password || '‚Äî';
    document.getElementById('checkin').textContent = data.checkin || '‚Äî';
    document.getElementById('checkout').textContent = data.checkout || '‚Äî';

    const hostInfo = document.getElementById('host-info');
    let hostHtml = '';
    if (data.host_telefono) hostHtml += `<a href="tel:${data.host_telefono.replace(/\s/g,'')}">${data.host_telefono}</a>`;
    if (data.host_email) hostHtml += `${hostHtml ? ' ‚Ä¢ ' : ''}<a href="mailto:${data.host_email}">${data.host_email}</a>`;
    hostInfo.innerHTML = hostHtml || '‚Äî';

    document.getElementById('checkin-note').textContent = data.checkin_note || '';
    document.getElementById('regole').innerHTML = data.regole || '‚Äî';
    document.getElementById('emergenze').innerHTML = data.emergenze || '‚Äî';
    document.getElementById('funzionamento').innerHTML = data.funzionamento || '‚Äî';
    document.getElementById('contact-block').innerHTML = hostInfo.innerHTML + (data.indirizzo ? `<p style="margin-top:16px"><strong>Indirizzo:</strong><br>${data.indirizzo}</p>` : '');

    if (data.mappa_embed) {
      document.getElementById('mappa').src = data.mappa_embed;
    }

    if (data.lat && data.lon) {
      loadWeather(data.lat, data.lon, data.nome);
    }

    renderRestaurants(data.ristoranti || []);
    renderActivities(data.attivita || []);
    renderGallery(data.galleria || []);
  }

  function renderRestaurants(restaurants) {
    const container = document.getElementById('luoghi-wrap');
    container.innerHTML = '';
    allRestaurants = restaurants;

    restaurants.forEach(r => {
      // Estrai distanza numerica per i filtri
      const distMatch = (r.distanza || '').match(/(\d+)/);
      const distNum = distMatch ? distMatch[1] : '999';

      const card = document.createElement('article');
      card.className = 'q-card';
      card.dataset.price = r.prezzo || '';
      card.dataset.distance = distNum;

      card.innerHTML = `
        <div class="q-img"><img src="${r.foto || ''}" alt="${r.nome || ''}" loading="lazy"></div>
        <div style="padding:12px">
          <div class="q-title">${r.nome || ''}</div>
          <div class="q-small">
            ${r.prezzo ? `<span class="q-chip">${r.prezzo}</span>` : ''}
            ${r.distanza ? ` ‚Ä¢ ${r.distanza}` : ''}
          </div>
          <div class="q-small" style="margin-top:6px">${r.descrizione || ''}</div>
          <div class="q-cta" style="margin-top:10px">
            ${r.telefono ? `<a class="q-btn" href="tel:${(r.telefono || '').replace(/\s/g,'')}" aria-label="Chiama ${r.nome || ''}"><svg class="q-ico q-ico-sm"><use href="#q-phone"/></svg><span data-i18n="call">Chiama</span></a>` : ''}
            ${r.maps ? `<a class="q-btn" href="${r.maps}" target="_blank" rel="noopener noreferrer" aria-label="Vai su Maps per ${r.nome || ''}"><svg class="q-ico q-ico-sm"><use href="#q-pin"/></svg><span data-i18n="maps">Maps</span></a>` : ''}
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function renderActivities(activities) {
    const container = document.getElementById('attivita-wrap');
    container.innerHTML = '';

    activities.forEach(a => {
      const card = document.createElement('article');
      card.className = 'q-card';
      card.innerHTML = `
        <div class="q-img"><img src="${a.foto || ''}" alt="${a.nome || ''}" loading="lazy"></div>
        <div style="padding:12px">
          <div class="q-title">${a.nome || ''}</div>
          <div class="q-small">${a.distanza || ''}</div>
          <div class="q-small" style="margin-top:6px">${a.descrizione || ''}</div>
          ${a.maps ? `<div class="q-cta" style="margin-top:10px"><a class="q-btn" href="${a.maps}" target="_blank" rel="noopener noreferrer" aria-label="Vai su Maps per ${a.nome || ''}"><svg class="q-ico q-ico-sm"><use href="#q-pin"/></svg><span data-i18n="maps">Maps</span></a></div>` : ''}
        </div>
      `;
      container.appendChild(card);
    });
  }

  function renderGallery(photos) {
    const container = document.getElementById('gallery-wrap');
    container.innerHTML = '';
    photos.forEach((photo, idx) => {
      const img = document.createElement('div');
      img.className = 'q-card q-img';
      img.innerHTML = `<img src="${photo}" alt="Foto appartamento ${idx + 1}" loading="lazy">`;
      container.appendChild(img);
    });
  }

  function detectLanguage() {
    const saved = localStorage.getItem('qrelax-lang');
    if (saved && TRANSLATIONS[saved]) return saved;
    const browser = navigator.language.slice(0, 2);
    return TRANSLATIONS[browser] ? browser : 'it';
  }

  function translatePage(lang) {
    currentLang = lang;
    localStorage.setItem('qrelax-lang', lang);
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.dataset.i18n;
      if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) {
        el.textContent = TRANSLATIONS[lang][key];
      }
    });
  }

  // =========================
  //     EVENT LISTENERS
  // =========================
  document.addEventListener('click', function(e) {
    // Theme toggle
    if (e.target && (e.target.id === 'theme-toggle' || e.target.closest('#theme-toggle'))) {
      e.preventDefault();
      toggleTheme();
      return;
    }

    // Language switcher
    if (e.target && e.target.classList.contains('lang-btn')) {
      e.preventDefault();
      translatePage(e.target.dataset.lang);
      return;
    }

    // Restaurant filters
    if (e.target && e.target.classList.contains('filter-btn')) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');
      filterRestaurants(e.target.dataset.filter);
      return;
    }

    // Copy wifi password
    if(e.target && e.target.id === 'copyPass'){
      e.preventDefault();
      const t = document.getElementById('wifi-pass');
      if(!t) return;
      navigator.clipboard.writeText((t.textContent||'').trim()).then(()=> {
        const n = document.getElementById('copiedMsg');
        n.style.display = 'inline';
        announce('Password WiFi copiata');
        setTimeout(()=> n.style.display = 'none', 1500);
      }).catch(()=> alert('Impossibile copiare negli appunti'));
    }
  });

  // =========================
  //          INIT
  // =========================
  (async function init() {
    initTheme();
    const lang = detectLanguage();
    const slug = getApartmentSlug();

    translatePage(lang);

    const data = await loadApartmentData(slug);
    if (data) {
      renderApartment(data);
      showApp();
      announce('Pagina caricata');
    }
  })();
  </script>
</body>
</html>

